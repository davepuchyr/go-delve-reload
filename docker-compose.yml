version: "2.4"

# begin resuble block https://dockr.ly/3cDXmKA
x-api: &default-api
  build:
    context: ./api
    target: dev
  environment:
    CGO_ENABLED: 0
    API_DB_HOST: db
    API_DB_DISABLE_TLS: "true"
    API_WEB_PRODUCTION: "false"
    API_WEB_ADDRESS: :$API_PORT
    API_WEB_DEBUG: :$PPROF_PORT
    API_WEB_READ_TIMEOUT: 7s
    API_WEB_WRITE_TIMEOUT: 7s
    API_WEB_SHUTDOWN_TIMEOUT: 7s
    API_WEB_FRONTEND_ADDRESS: $API_WEB_FRONTEND_ADDRESS
  volumes:
    - ./api:/api
  networks:
    - postgres-net
  depends_on:
    db:
      condition: service_healthy
# end resuble block

services:
  api:
    <<: *default-api
    ports:
      - $API_PORT:$API_PORT
      - $PPROF_PORT:$PPROF_PORT
    # swap commands to disable live reload
    # command: go run ./cmd/api
    command: CompileDaemon --build="go build -o main ./cmd/api" -log-prefix=false --command=./main

  client:
    build:
      context: ./client
      target: dev
    environment:
      HTTPS: "true"
      REACT_APP_BACKEND: $REACT_APP_BACKEND
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - $CLIENT_PORT:$CLIENT_PORT
    # fixes bug in create-react-app https://bit.ly/3dVy3Uw
    tty: true
    stdin_open: true
    volumes:
      - ./client:/client/app
      - /client/app/node_modules

  debug-api:
    <<: *default-api # insert resuble block
    environment:
      API_WEB_ADDRESS: :8888
      API_WEB_DEBUG: :6061
    ports:
      - 2345:2345
      - 8888:8888
      - 6061:6061
    # run a container without the default seccomp profile https://bit.ly/3bGjhj1
    security_opt:
      - "seccomp:unconfined"
    tty: true
    stdin_open: true
    command: dlv debug --accept-multiclient --continue --headless --listen=:2345 --api-version=2 --log ./cmd/api/
